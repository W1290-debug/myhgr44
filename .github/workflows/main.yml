name: VNC Desktop VPS
on:
  workflow_dispatch:
jobs:
  vnc-desktop:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    steps:
      - name: Setup VNC Server and Desktop
        run: |
          sudo apt-get update
          sudo apt-get install -y xfce4 xfce4-goodies tightvncserver
          echo "âœ… Desktop and VNC server installed."

      - name: Configure VNC and Start It
        run: |
          # Ø¥Ø¹Ø¯Ø§Ø¯ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± VNC
          mkdir -p ~/.vnc
          echo '${{ secrets.VNC_PASSWORD }}' | vncpasswd -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd
          
          # Ø¨Ø¯Ø¡ Ø®Ø§Ø¯Ù… VNC Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø±Ù‚Ù… 1 (Ø§Ù„Ù…Ù†ÙØ° 5901)
          # ÙˆØ±Ø¨Ø·Ù‡ Ø¨Ø¨ÙŠØ¦Ø© Ø³Ø·Ø­ Ø§Ù„Ù…ÙƒØªØ¨ XFCE
          vncserver :1 -geometry 1280x720 -depth 24 -localhost
          echo "âœ… VNC server started on :1 (port 5901)."

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=vnc-desktop-${{ github.run_id }}
          tsIP=$(tailscale ip -4 | head -n 1)
          echo "TAILSCALE_IP=$tsIP" >> $GITHUB_ENV
          echo "âœ… Tailscale IP: $tsIP"

      - name: Display Connection Info
        run: |
          echo "ğŸš€ VNC Desktop VPS is ready!"
          echo "--------------------------------------------------"
          echo "ğŸ“ Tailscale IP: $TAILSCALE_IP"
          echo "ğŸ–¥ï¸  VNC Port: 5901"
          echo "ğŸ” To connect, open your VNC Viewer and connect to:"
          echo "    $TAILSCALE_IP:5901"
          echo "ğŸ”‘ Use the VNC password you set in the repository secrets."
          echo "--------------------------------------------------"

      - name: Keep VPS Alive
        run: |
          while true; do
            echo "[$(date)] VNC Desktop VPS running..."
            sleep 300
          done
